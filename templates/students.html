{% extends "base.html" %}

{% block content %}
<h2 class="mb-3">O‘quvchilar ro‘yxati</h2>

<!-- Filter & Search -->
<form class="row g-2 mb-3" method="GET" action="{{ url_for('students') }}">
  <div class="col-md-3">
    <input type="text"
           name="q"
           value="{{ q }}"
           class="form-control"
           placeholder="Qidiruv…">
  </div>
  <div class="col-md-2">
    <select name="status"
            class="form-select"
            multiple
            size="3">
      <option value="active"  {% if 'active'  in statuses %}selected{% endif %}>Active</option>
      <option value="left"    {% if 'left'    in statuses %}selected{% endif %}>Left</option>
      <option value="on-hold" {% if 'on-hold' in statuses %}selected{% endif %}>On-hold</option>
    </select>
  </div>
  <div class="col-md-3">
    <select name="group"
            class="form-select"
            multiple
            size="5">
      {% for g in groups %}
      <option value="{{ g.id }}"
              {% if g.id in group_ids %}selected{% endif %}>
        {{ g.name }}
      </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">Filtrlash</button>
  </div>
  <div class="col-md-2">
    <button type="button"
            class="btn btn-success w-100"
            data-bs-toggle="modal"
            data-bs-target="#addStudentModal">
      + O‘quvchi qo‘shish
    </button>
  </div>
</form>

<!-- Students Table -->
<table class="table table-hover table-bordered">
  <thead class="table-light">
    <tr>
      <th>ID</th>
      <th>Ism</th>
      <th>Guruh(lar)</th>
      <th>Status</th>
      <th>Ota-ona</th>
      <th>Telefonlar</th>
      <th>Qo‘shilgan sana</th>
      <th>Oylik kuni</th>
      <th>Komment</th>
      <th>Amal</th>
    </tr>
  </thead>
  <tbody>
    {% for s in students %}
    <tr>
      <td>{{ s.id }}</td>
      <td>
        <a href="{{ url_for('student_detail', id=s.id) }}">
          {{ s.fullname }}
        </a>
      </td>
      <td>
        {% for g in s.groups %}
          {{ g.name }}{% if not loop.last %}, {% endif %}
        {% endfor %}
      </td>
      <td>{{ s.status }}</td>
      <td>{{ s.parent_name }}</td>
      <td>
        {{ s.phone1 }}<br>
        {{ s.phone2 }}<br>
        {{ s.phone3 }}
      </td>
      <td>{{ s.join_date }}</td>
      <td>{{ s.payment_day }}-kun</td>
      <td>{{ s.comments }}</td>
      <td>
        <button type="button"
                class="btn btn-sm btn-outline-info edit-btn"
                data-id="{{ s.id }}">
          Tahrirlash
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{# Qo‘shish va tahrirlash modallarini konteksti bilan include qilamiz #}
{% include 'student_form_modal.html' with context %}
{% endblock %}


{% block scripts %}
  <!-- Bootstrap 5 JS bundle (Popper.js kiradi) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery faqat AJAX uchun -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script>
    // Modalni ochish va formani to‘ldirish
    function openEditModal(id) {
      document.getElementById('editStudentForm').action = `/student/${id}/edit`;
      $.getJSON(`/student/${id}/json`, data => {
        $('#edit_fullname').val(data.fullname);
        $('#edit_parent_name').val(data.parent_name);
        $('#edit_phone1').val(data.phone1);
        $('#edit_phone2').val(data.phone2);
        $('#edit_phone3').val(data.phone3);
        $('#edit_status').val(data.status);
        $('#edit_join_date').val(data.join_date);
        $('#edit_payment_day').val(data.payment_day);
        $('#edit_comments').val(data.comments);
        $('#edit_groups option').prop('selected', false);
        data.groups.forEach(gid => {
          $(`#edit_groups option[value="${gid}"]`).prop('selected', true);
        });
        new bootstrap.Modal(document.getElementById('editStudentModal')).show();
      });
    }

    // DOM tayyor bo‘lgach, tugmalarni bog‘laymiz
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(btn.dataset.id));
      });
    });
  </script>
{% endblock %}
